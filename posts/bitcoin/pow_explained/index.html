<!DOCTYPE html>
<html lang="en"><head>
	<meta charset="UTF-8">
	<meta name="description" content="Interested in Blockchains, Cryptography and Distributed Systems.">
	<meta name="keywords" content="computer, security, ethical hacker, researcher, inventor, abertay, dundee, edinburgh, machine learning, mathematics, cryptography, blockchains, reverse engineering, linux, programming, scotland, greg hill">
	<meta name="author" content="Gregory Hill">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Gregory Hill | Proof of Work (Explained)</title>
	<link href="../../../css/style.css" rel="stylesheet">
	<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
	<link rel="apple-touch-icon" sizes="180x180" href="../../../img/apple-touch-icon.png">
	<link rel="icon" type="image/png" href="../../../img/favicon-32x32.png" sizes="32x32">
	<link rel="icon" type="image/png" href="../../../img/favicon-16x16.png" sizes="16x16">
	<link rel="manifest" href="../../../img/manifest.json">
	<link rel="mask-icon" href="../../../img/safari-pinned-tab.svg" color="#5bbad5">
	<link rel="shortcut icon" href="../../../img/favicon.ico">
	<meta name="msapplication-config" content="/img/browserconfig.xml">
	<meta name="theme-color" content="#ffffff">
	
</head><body>
    <main><div class="post">
    <div class="post-info">
        
        Dec 22, 2019
        · 366 words
        · 2 minute read
        
    </div>

    <h1 class="post-title">
        Proof of Work (Explained)
    </h1>

    <div class="post-tags"><a class="tag" href=../../../tags/bitcoin/>#bitcoin</a><a class="tag" href=../../../tags/c&#43;&#43;/>#c&#43;&#43;</a></div>

    <div class="post-body">
        <p>So you&rsquo;ve read the theory, but want to understand Bitcoin programmatically. In this post we will analyse the
core codebase written in C++ to understand how one can generate and include a block in the chain. Starting with
the atomic unit of construction in this context, a block is a grouping of transactions that alter the state of
the ledger. For example, a <code>coinbase</code> transaction may be included by a miner to collect a block reward. But in
order for these to be processed by the network, a miner must provide a proof of work for the serialization of
the following fields:</p>
<ul>
<li><code>nVersion</code></li>
<li><code>hashPrevBlock</code></li>
<li><code>hashMerkleRoot</code></li>
<li><code>nTime</code></li>
<li><code>nBits</code></li>
<li><code>nNonce</code></li>
</ul>
<p>The class definition of a block header is shown in the following snippet, of particular interest is <code>SerializationOp</code>
which tells the compiler how an instance of this class should be serialized and <code>GetHash</code> which returns a 256-bit
unsigned integer.</p>
<!-- https://github.com/bitcoin/bitcoin/blob/5622d8f3156a293e61d0964c33d4b21d8c9fd5e0/src/primitives/block.h#L20-L69 -->
<script charset="UTF-8" src="https://gist-it.appspot.com/github.com/bitcoin/bitcoin/blob/5622d8f3156a293e61d0964c33d4b21d8c9fd5e0/src/primitives/block.h?slice=19:69&footer=minimal"></script>
<p>The implementation of <code>GetHash</code> calls another function <code>SerializeHash</code> passing a dereferenced pointer to its context.</p>
<script charset="UTF-8" src="https://gist-it.appspot.com/github.com/bitcoin/bitcoin/blob/5622d8f3156a293e61d0964c33d4b21d8c9fd5e0/src/primitives/block.cpp?slice=9:15&footer=minimal"></script>
<p>From here, <code>CHashWriter</code> is established which computes the digest via the <code>CHash256</code> class.</p>
<script charset="UTF-8" src="https://gist-it.appspot.com/github.com/bitcoin/bitcoin/blob/5622d8f3156a293e61d0964c33d4b21d8c9fd5e0/src/hash.h?slice=115:140&footer=minimal"></script>
<p>We can see that <code>Finalize</code> writes and flushes the hash to the input buffer. It is important to note that
this actually computes <code>SHA-256d</code> (double) in an effort to prevent &ldquo;length-extension&rdquo; attacks.</p>
<script charset="UTF-8" src="https://gist-it.appspot.com/github.com/bitcoin/bitcoin/blob/5622d8f3156a293e61d0964c33d4b21d8c9fd5e0/src/hash.h?slice=20:43&footer=minimal"></script>
<p>Assuming this process has given us a valid digest of our input, how can we convince other participants to
append our block to their view of the chain? This is where the consensus parameter <code>bnTarget</code> comes in.
For brevity, we will ignore how this is chosen but I will note that this is dynamic - the network adapts it
based on mining speeds. Honest nodes will thus accept a gossiped block under the condition that the arithmetical
representation of its hash is less that that of the current target.</p>
<!-- https://github.com/bitcoin/bitcoin/blob/5622d8f3156a293e61d0964c33d4b21d8c9fd5e0/src/pow.cpp#L74-L91 -->
<script charset="UTF-8" src="https://gist-it.appspot.com/github.com/bitcoin/bitcoin/blob/5622d8f3156a293e61d0964c33d4b21d8c9fd5e0/src/pow.cpp?slice=73:91&footer=minimal"></script>
<p>To recompute a new hash, we need some variability in the form of <code>nNonce</code>. As there is no way to predict what input will lead to
a desired hash, all we can do is increment it. There&rsquo;s a useful example of this in the following test helper.</p>
<!-- https://github.com/bitcoin/bitcoin/blob/5622d8f3156a293e61d0964c33d4b21d8c9fd5e0/src/test/util.cpp#L61-L64 -->
<script charset="UTF-8" src="https://gist-it.appspot.com/github.com/bitcoin/bitcoin/blob/5622d8f3156a293e61d0964c33d4b21d8c9fd5e0/src/test/util.cpp?slice=60:64&footer=minimal"></script>
<p>Providing the final hash meets the criteria and enough nodes know about it, subsequent miners will include it as
<code>hashPrevBlock</code> in their constructions.</p>

    </div>
</div></main>
</body><footer>

    
    <a class="footer-social" href="https://github.com/gregdhill">
        <i class="grow fa fa-github fa-2x" aria-hidden="true"></i>
    </a>
    
    <a class="footer-social" href="https://twitter.com/gregorydhill">
        <i class="grow fa fa-twitter fa-2x" aria-hidden="true"></i>
    </a>
    
    <a class="footer-social" href="https://scholar.google.co.uk/citations?user=OoKiidsAAAAJ&amp;hl=en">
        <i class="grow fa fa-graduation-cap fa-2x" aria-hidden="true"></i>
    </a>
    

</footer></html>