<!DOCTYPE html>
<html lang="en-gb">
    <head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">

		<title>Upgradable Proxy Contracts &middot; Greg Hill</title>

		
  		<link rel="stylesheet" href="/css/style.css">
		<link rel="stylesheet" href="/css/fonts.css">
		
		<link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
		<link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

		
		<link href="" rel="alternate" type="application/rss+xml" title="Greg Hill" />
	</head>

    <body>
        		<nav class="nav">
			<div class="nav-container">
				<a href="/">
					<h2 class="nav-title">Greg Hill</h2>
				</a>
				<ul>
    
    
        <li>
            <a href="/posts/">
                
                <span>Posts</span>
                
            </a>
        </li>
    
        <li>
            <a href="/projects/">
                
                <span>Projects</span>
                
            </a>
        </li>
    
</ul>
			</div>
		</nav>

        

<main>
	<div class="post">
		<div class="post-info">
    <span>Written by</span>
        Gregory Hill
        <br>
        <span>on&nbsp;</span><time datetime="2020-04-06 00:00:00 &#43;0000 UTC">April 6, 2020</time>
</div>
		<h1 class="post-title">Upgradable Proxy Contracts</h1>
<div class="post-line"></div>

		

		<p>Smart contracts in Ethereum are immutable; once they have been included in a block they cannot be changed. This is a weird philosophy to adopt from a software engineering perspective. What if there are bugs in your code? Solidity has a <a href="https://consensys.github.io/smart-contract-best-practices/known_attacks/">plethora of known attacks</a> which, given the economical value at risk, is troubling to say the least. However, we also do not want to interact with an unstable application that can be arbitrarily updated.</p>
<p>One of the more impressive concepts that I learned recently regards the decoupling of state and functionality. By separating <em>what</em> a contract stores from <em>how</em> it accesses it we can easily upgrade a contract on chain. Using the infamous DAO hack as an example, let&rsquo;s assume we have a smart contract which stores an amount of funds but also suffers from the reentrancy bug. Without changing the underlying state, we want to rewire the logic to prevent it from being exploited. Additionally, we may not want to force the original consumers to use a new (pre-initialized) contract.</p>
<p>Before getting into the details, we first need to understand the difference between <code>CALL</code> and <code>DELEGATECALL</code>. If we call a class method in the traditional sense, then we only expect it to alter it&rsquo;s own internal state (omitting arguments). Conversely, if something is delegated then we entrust someone to carry out a task on our behalf. These concepts naturally extend to Ethereum; if we delegate a call we ask a contract to operate on our state instead of it&rsquo;s own.</p>
<p>In the following example I have defined two contracts; <code>Setter</code> exposes a method to directly alter it&rsquo;s state through the <code>set</code> function, and <code>Getter</code> contains the two forward calls described above. Notice the calling <code>set</code> or <code>call</code> will alter the <code>value</code> stored in <code>Setter</code>, whereas <code>delegatecall</code> will update the <code>value</code> in <code>Getter</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-solidity" data-lang="solidity"><span class="kr">pragma solidity</span> <span class="o">&gt;=</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">.</span><span class="mi">0</span><span class="p">;</span>

<span class="kd">contract</span> <span class="n">Setter</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="kr">public</span> <span class="nb">value</span><span class="p">;</span>
    
    <span class="kd">function</span> <span class="n">set</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">_value</span><span class="p">)</span> <span class="kr">external</span> <span class="p">{</span>
        <span class="nb">value</span> <span class="o">=</span> <span class="n">_value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">contract</span> <span class="n">Getter</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="kr">public</span> <span class="nb">value</span><span class="p">;</span>
    
    <span class="kd">function</span> <span class="nb">call</span><span class="p">(</span><span class="kt">address</span> <span class="n">setter</span><span class="p">,</span> <span class="kt">uint256</span> <span class="nb">value</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="n">setter</span><span class="p">.</span><span class="nb">call</span><span class="p">(</span><span class="n">abi</span><span class="p">.</span><span class="n">encodeWithSignature</span><span class="p">(</span><span class="s">&#34;set(uint256)&#34;</span><span class="p">,</span> <span class="nb">value</span><span class="p">));</span>
    <span class="p">}</span>
    
    <span class="kd">function</span> <span class="nb">delegatecall</span><span class="p">(</span><span class="kt">address</span> <span class="n">setter</span><span class="p">,</span> <span class="kt">uint256</span> <span class="nb">value</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="n">setter</span><span class="p">.</span><span class="nb">delegatecall</span><span class="p">(</span><span class="n">abi</span><span class="p">.</span><span class="n">encodeWithSignature</span><span class="p">(</span><span class="s">&#34;set(uint256)&#34;</span><span class="p">,</span> <span class="nb">value</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>Another feature of Solidity that we will utilise is known as the fallback function. This unnamed function cannot take any arguments and is not able to return anything, but will run instead if the called function is not found - suitable for a proxy.</p>
<p>The proxy technique was first popularized by Nick Johnson of the Ethereum Foundation <a href="https://gist.github.com/Arachnid/4ca9da48d51e23e5cfe0f0e14dd6318f">here</a>. The basic idea is that the proxy extends the same storage layout but would forward any and all calls to the registered logic contract.</p>
<p>In this example, we first deploy the proxy and then register either of the two functional contracts to update the <code>value</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-solidity" data-lang="solidity"><span class="kd">contract</span> <span class="n">Storage</span> <span class="p">{</span>
    <span class="kt">uint</span> <span class="kr">public</span> <span class="nb">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">contract</span> <span class="n">Proxy</span> <span class="kr">is</span> <span class="n">Storage</span> <span class="p">{</span>
    <span class="kt">address</span> <span class="kr">internal</span> <span class="n">proxied</span><span class="p">;</span>

    <span class="kd">function</span> <span class="n">redirect</span><span class="p">(</span><span class="kt">address</span> <span class="n">_proxied</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="n">proxied</span> <span class="o">=</span> <span class="n">_proxied</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="p">()</span> <span class="kr">external</span> <span class="kr">payable</span> <span class="p">{</span>
        <span class="kt">address</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">proxied</span><span class="p">;</span>
        <span class="k">assembly</span> <span class="p">{</span>
            <span class="ow">let</span> <span class="nv">freememstart</span> <span class="o">:=</span> <span class="nf">mload</span><span class="p">(</span><span class="mh">0x40</span><span class="p">)</span>
            <span class="nf">calldatacopy</span><span class="p">(</span><span class="n">freememstart</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nf">calldatasize</span><span class="p">())</span>
            <span class="ow">let</span> <span class="nv">success</span> <span class="o">:=</span> <span class="nf">delegatecall</span><span class="p">(</span><span class="nf">not</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">addr</span><span class="p">,</span> <span class="n">freememstart</span><span class="p">,</span> <span class="nf">calldatasize</span><span class="p">(),</span> <span class="n">freememstart</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span>
            <span class="nf">switch</span> <span class="n">success</span>
            <span class="n">case</span> <span class="mi">0</span> <span class="p">{</span> <span class="nf">revert</span><span class="p">(</span><span class="n">freememstart</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="p">}</span>
            <span class="n">default</span> <span class="p">{</span> <span class="nf">return</span><span class="p">(</span><span class="n">freememstart</span><span class="p">,</span> <span class="mi">32</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">contract</span> <span class="n">Addition</span> <span class="kr">is</span> <span class="n">Storage</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="n">add</span><span class="p">(</span><span class="kt">uint</span> <span class="n">_value</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nb">value</span> <span class="o">+=</span> <span class="n">_value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">contract</span> <span class="n">Subtraction</span> <span class="kr">is</span> <span class="n">Storage</span> <span class="p">{</span>
    <span class="kd">function</span> <span class="n">sub</span><span class="p">(</span><span class="kt">uint</span> <span class="n">_value</span><span class="p">)</span> <span class="kr">public</span> <span class="p">{</span>
        <span class="nb">value</span> <span class="o">-=</span> <span class="n">_value</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div><p>If you are interested in learning about other proxy patterns, read the <a href="https://blog.openzeppelin.com/proxy-patterns/">fantastic article by OpenZeppelin</a>.</p>


		
	</div>

	<div class="pagination">
		<a href="/posts/travel/hyperledger_gf_2020/" class="left arrow">&#8592;</a>

		<a href="#" class="top">Top</a>
	</div>
</main>


        		<footer>
			<span>
			&copy; <time datetime="2020-04-07 16:25:22.488541473 &#43;0100 BST m=&#43;0.100926567">2020</time> Greg Hill. Made with <a href='https://gohugo.io'>Hugo</a> using the <a href='https://github.com/EmielH/tale-hugo/'>Tale</a> theme.
			</span>
		</footer>

    </body>
</html>
